instructorRouter.post(
  "/course/:courseId/section",
  auth,
  instructorAuth,
  upload.fields([
    { name: "videoUrl", maxCount: 1 },
    { name: "cheatSheetUrl", maxCount: 1 },
  ]),
  async (req, res) => {
    try {
      const { courseId } = req.params;
      const { sectionTitle, lessonTitle, duration } = req.body;

      if (!sectionTitle?.trim() || !lessonTitle?.trim()) {
        return res.status(400).json({
          error: "Section title and Lesson title are required",
        });
      }

      if (!req.files?.videoUrl || !req.files?.cheatSheetUrl) {
        return res.status(400).json({
          error: "Video and Cheat Sheet are required",
        });
      }

      const videoFile = req.files.videoUrl[0];
      const cheatSheetFile = req.files.cheatSheetUrl[0];

      const videoUpload = await uploadToCloudinary(
        videoFile.buffer,
        "LMS/courses/sections",
        videoFile.mimetype
      );

      const cheatSheetUpload = await uploadToCloudinary(
        cheatSheetFile.buffer,
        "LMS/courses/sections",
        cheatSheetFile.mimetype
      );

      const course = await Course.findById(courseId);
      if (!course) {
        return res.status(404).json({ error: "Course not found" });
      }

      const lesson = {
        title: lessonTitle.trim(),
        videoUrl: videoUpload.secure_url,
        videoPublicId: videoUpload.public_id,
        cheatSheetUrl: cheatSheetUpload.secure_url,
        cheatSheetPublicId: cheatSheetUpload.public_id,
        duration: Number(duration) || 0,
      };

      // ✅ Check if section already exists
      let section = course.sections.find(
        (sec) => sec.title === sectionTitle.trim()
      );

      if (!section) {
        // ✅ Create new section if not exists
        course.sections.push({
          title: sectionTitle.trim(),
          lessons: [lesson],
        });
      } else {
        // ✅ Push lesson into existing section
        section.lessons.push(lesson);
      }

      await course.save();

      res.status(201).json({
        message: "Section & Lesson added successfully",
        sectionTitle,
        lessonTitle,
      });
    } catch (error) {
      console.log(error);
      res.status(500).json({ error: error.message });
    }
  }
);
